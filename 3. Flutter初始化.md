# [FlutterApplication](https://github.com/flutter/engine/blob/master/shell/platform/android/io/flutter/app/FlutterApplication.java)

```java
package io.flutter.app;

……
import io.flutter.view.FlutterMain;

/**
 * Flutter implementation of {@link android.app.Application}, managing application-level global
 * initializations.
 *
 * <p>Using this {@link android.app.Application} is not required when using APIs in the package
 * {@code io.flutter.embedding.android} since they self-initialize on first use.
 */
public class FlutterApplication extends Application {
  @Override
  @CallSuper
  public void onCreate() {
    super.onCreate();
    FlutterMain.startInitialization(this);
  }

  ……
}
```

# [FlutterMain](https://github.com/flutter/engine/blob/master/shell/platform/android/io/flutter/view/FlutterMain.java)

```java
package io.flutter.app;

……
// Copyright 2013 The Flutter Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

package io.flutter.view;

……
import androidx.annotation.Nullable;
import io.flutter.embedding.engine.loader.FlutterLoader;

/**
 * A legacy class to initialize the Flutter engine.
 *
 * <p>Replaced by {@link io.flutter.embedding.engine.loader.FlutterLoader}.
 */
public class FlutterMain {

  public static class Settings {
    private String logTag;

    @Nullable
    public String getLogTag() {
      return logTag;
    }

    /**
     * Set the tag associated with Flutter app log messages.
     *
     * @param tag Log tag.
     */
    public void setLogTag(String tag) {
      logTag = tag;
    }
  }

  /**
   * Starts initialization of the native system.
   *
   * @param applicationContext The Android application context.
   */
  public static void startInitialization(@NonNull Context applicationContext) {
    if (isRunningInRobolectricTest) {
      return;
    }
    FlutterLoader.getInstance().startInitialization(applicationContext);
  }

  /**
   * Starts initialization of the native system.
   *
   * <p>This loads the Flutter engine's native library to enable subsequent JNI calls. This also
   * starts locating and unpacking Dart resources packaged in the app's APK.
   *
   * <p>Calling this method multiple times has no effect.
   *
   * @param applicationContext The Android application context.
   * @param settings Configuration settings.
   */
  public static void startInitialization(
      @NonNull Context applicationContext, @NonNull Settings settings) {
    if (isRunningInRobolectricTest) {
      return;
    }
    FlutterLoader.Settings newSettings = new FlutterLoader.Settings();
    newSettings.setLogTag(settings.getLogTag());
    FlutterLoader.getInstance().startInitialization(applicationContext, newSettings);
  }

  ……
}
```

# [FlutterLoader](https://github.com/flutter/engine/blob/master/shell/platform/android/io/flutter/embedding/engine/loader/FlutterLoader.java)

```java
package io.flutter.embedding.engine.loader;

……

/** Finds Flutter resources in an application APK and also loads Flutter's native library. */
public class FlutterLoader {
  ……

  /**
   * Starts initialization of the native system.
   *
   * <p>This loads the Flutter engine's native library to enable subsequent JNI calls. This also
   * starts locating and unpacking Dart resources packaged in the app's APK.
   *
   * <p>Calling this method multiple times has no effect.
   *
   * @param applicationContext The Android application context.
   * @param settings Configuration settings.
   */
  public void startInitialization(@NonNull Context applicationContext, @NonNull Settings settings) {
    // Do not run startInitialization more than once.
    if (this.settings != null) {
      return;
    }
    if (Looper.myLooper() != Looper.getMainLooper()) {
      throw new IllegalStateException("startInitialization must be called on the main thread");
    }

    // Ensure that the context is actually the application context.
    final Context appContext = applicationContext.getApplicationContext();

    this.settings = settings;

    initStartTimestampMillis = SystemClock.uptimeMillis();
    initConfig(appContext);
    VsyncWaiter.getInstance((WindowManager) appContext.getSystemService(Context.WINDOW_SERVICE))
        .init();

    // Use a background thread for initialization tasks that require disk access.
    Callable<InitResult> initTask =
        new Callable<InitResult>() {
          @Override
          public InitResult call() {
            ResourceExtractor resourceExtractor = initResources(appContext);

            System.loadLibrary("flutter");

            // Prefetch the default font manager as soon as possible on a background thread.
            // It helps to reduce time cost of engine setup that blocks the platform thread.
            Executors.newSingleThreadExecutor()
                .execute(
                    new Runnable() {
                      @Override
                      public void run() {
                        FlutterJNI.nativePrefetchDefaultFontManager();
                      }
                    });

            if (resourceExtractor != null) {
              resourceExtractor.waitForCompletion();
            }

            return new InitResult(
                PathUtils.getFilesDir(appContext),
                PathUtils.getCacheDirectory(appContext),
                PathUtils.getDataDirectory(appContext));
          }
        };
    initResultFuture = Executors.newSingleThreadExecutor().submit(initTask);
  }

  ……

  public static class Settings {
    private String logTag;

    @Nullable
    public String getLogTag() {
      return logTag;
    }

    /**
     * Set the tag associated with Flutter app log messages.
     *
     * @param tag Log tag.
     */
    public void setLogTag(String tag) {
      logTag = tag;
    }
  }
}

```

## 1. [initConfig](https://github.com/flutter/engine/blob/master/shell/platform/android/io/flutter/embedding/engine/loader/FlutterLoader.java#L314)

```java
// Copyright 2013 The Flutter Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

package io.flutter.embedding.engine.loader;

……

/** Finds Flutter resources in an application APK and also loads Flutter's native library. */
public class FlutterLoader {
  private static final String TAG = "FlutterLoader";

  // Must match values in flutter::switches
  private static final String AOT_SHARED_LIBRARY_NAME = "aot-shared-library-name";
  private static final String SNAPSHOT_ASSET_PATH_KEY = "snapshot-asset-path";
  private static final String VM_SNAPSHOT_DATA_KEY = "vm-snapshot-data";
  private static final String ISOLATE_SNAPSHOT_DATA_KEY = "isolate-snapshot-data";
  private static final String FLUTTER_ASSETS_DIR_KEY = "flutter-assets-dir";

  // XML Attribute keys supported in AndroidManifest.xml
  private static final String PUBLIC_AOT_SHARED_LIBRARY_NAME =
      FlutterLoader.class.getName() + '.' + AOT_SHARED_LIBRARY_NAME; // io.flutter.embedding.engine.loader.FlutterLoader.aot-shared-library-name
  private static final String PUBLIC_VM_SNAPSHOT_DATA_KEY =
      FlutterLoader.class.getName() + '.' + VM_SNAPSHOT_DATA_KEY; // io.flutter.embedding.engine.loader.FlutterLoader.vm-snapshot-data
  private static final String PUBLIC_ISOLATE_SNAPSHOT_DATA_KEY =
      FlutterLoader.class.getName() + '.' + ISOLATE_SNAPSHOT_DATA_KEY; // io.flutter.embedding.engine.loader.FlutterLoader.isolate-snapshot-data
  private static final String PUBLIC_FLUTTER_ASSETS_DIR_KEY =
      FlutterLoader.class.getName() + '.' + FLUTTER_ASSETS_DIR_KEY; // io.flutter.embedding.engine.loader.FlutterLoader.flutter-assets-dir

  // Resource names used for components of the precompiled snapshot.
  private static final String DEFAULT_AOT_SHARED_LIBRARY_NAME = "libapp.so";
  private static final String DEFAULT_VM_SNAPSHOT_DATA = "vm_snapshot_data";
  private static final String DEFAULT_ISOLATE_SNAPSHOT_DATA = "isolate_snapshot_data";
  private static final String DEFAULT_LIBRARY = "libflutter.so";
  private static final String DEFAULT_KERNEL_BLOB = "kernel_blob.bin";
  private static final String DEFAULT_FLUTTER_ASSETS_DIR = "flutter_assets";

  // Mutable because default values can be overridden via config properties
  private String aotSharedLibraryName = DEFAULT_AOT_SHARED_LIBRARY_NAME;
  private String vmSnapshotData = DEFAULT_VM_SNAPSHOT_DATA;
  private String isolateSnapshotData = DEFAULT_ISOLATE_SNAPSHOT_DATA;
  private String flutterAssetsDir = DEFAULT_FLUTTER_ASSETS_DIR;

  ……

  /**
   * Starts initialization of the native system.
   *
   * <p>This loads the Flutter engine's native library to enable subsequent JNI calls. This also
   * starts locating and unpacking Dart resources packaged in the app's APK.
   *
   * <p>Calling this method multiple times has no effect.
   *
   * @param applicationContext The Android application context.
   * @param settings Configuration settings.
   */
  public void startInitialization(@NonNull Context applicationContext, @NonNull Settings settings) {
    // Do not run startInitialization more than once.
    if (this.settings != null) {
      return;
    }
    if (Looper.myLooper() != Looper.getMainLooper()) {
      throw new IllegalStateException("startInitialization must be called on the main thread");
    }

    // Ensure that the context is actually the application context.
    final Context appContext = applicationContext.getApplicationContext();

    this.settings = settings;

    initStartTimestampMillis = SystemClock.uptimeMillis();
    initConfig(appContext);
    ……
  }

  ……

  /**
   * Initialize our Flutter config values by obtaining them from the manifest XML file, falling back
   * to default values.
   */
  private void initConfig(@NonNull Context applicationContext) {
    Bundle metadata = getApplicationInfo(applicationContext).metaData;

    // There isn't a `<meta-data>` tag as a direct child of `<application>` in
    // `AndroidManifest.xml`.
    if (metadata == null) {
      return;
    }

    aotSharedLibraryName =
        metadata.getString(PUBLIC_AOT_SHARED_LIBRARY_NAME, DEFAULT_AOT_SHARED_LIBRARY_NAME); // DEFAULT_AOT_SHARED_LIBRARY_NAME = "libapp.so";
    flutterAssetsDir =
        metadata.getString(PUBLIC_FLUTTER_ASSETS_DIR_KEY, DEFAULT_FLUTTER_ASSETS_DIR); // DEFAULT_FLUTTER_ASSETS_DIR = "flutter_assets";

    vmSnapshotData = metadata.getString(PUBLIC_VM_SNAPSHOT_DATA_KEY, DEFAULT_VM_SNAPSHOT_DATA); // DEFAULT_VM_SNAPSHOT_DATA = "vm_snapshot_data";
    isolateSnapshotData =
        metadata.getString(PUBLIC_ISOLATE_SNAPSHOT_DATA_KEY, DEFAULT_ISOLATE_SNAPSHOT_DATA); // DEFAULT_ISOLATE_SNAPSHOT_DATA = "isolate_snapshot_data";
  }

  ……
}
```

## 2. [VsyncWaiter](https://github.com/flutter/engine/blob/master/shell/platform/android/io/flutter/view/VsyncWaiter.java)：监听垂直同步消息传递给Flutter

```java
// Copyright 2013 The Flutter Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

package io.flutter.embedding.engine.loader;

……

/** Finds Flutter resources in an application APK and also loads Flutter's native library. */
public class FlutterLoader {
  ……

  /**
   * Starts initialization of the native system.
   *
   * <p>This loads the Flutter engine's native library to enable subsequent JNI calls. This also
   * starts locating and unpacking Dart resources packaged in the app's APK.
   *
   * <p>Calling this method multiple times has no effect.
   *
   * @param applicationContext The Android application context.
   * @param settings Configuration settings.
   */
  public void startInitialization(@NonNull Context applicationContext, @NonNull Settings settings) {
    // Do not run startInitialization more than once.
    if (this.settings != null) {
      return;
    }
    if (Looper.myLooper() != Looper.getMainLooper()) {
      throw new IllegalStateException("startInitialization must be called on the main thread");
    }

    // Ensure that the context is actually the application context.
    final Context appContext = applicationContext.getApplicationContext();

    this.settings = settings;

    initStartTimestampMillis = SystemClock.uptimeMillis();
    initConfig(appContext);
    VsyncWaiter.getInstance((WindowManager) appContext.getSystemService(Context.WINDOW_SERVICE))
        .init();

    ……
  }

  ……
}

```

```java
package io.flutter.view;

import android.view.Choreographer;
import android.view.WindowManager;
import androidx.annotation.NonNull;
import io.flutter.embedding.engine.FlutterJNI;

// TODO(mattcarroll): add javadoc.
public class VsyncWaiter {
  private static VsyncWaiter instance;

  @NonNull
  public static VsyncWaiter getInstance(@NonNull WindowManager windowManager) {
    if (instance == null) {
      instance = new VsyncWaiter(windowManager);
    }
    return instance;
  }

  @NonNull private final WindowManager windowManager;

  private final FlutterJNI.AsyncWaitForVsyncDelegate asyncWaitForVsyncDelegate =
      new FlutterJNI.AsyncWaitForVsyncDelegate() {
        @Override
        public void asyncWaitForVsync(long cookie) {
          Choreographer.getInstance()
              .postFrameCallback(
                  new Choreographer.FrameCallback() { // 监听垂直同步消息传递给Flutter
                    @Override
                    public void doFrame(long frameTimeNanos) {
                      float fps = windowManager.getDefaultDisplay().getRefreshRate();
                      long refreshPeriodNanos = (long) (1000000000.0 / fps);
                      FlutterJNI.nativeOnVsync(
                          frameTimeNanos, frameTimeNanos + refreshPeriodNanos, cookie);
                    }
                  });
        }
      };

  private VsyncWaiter(@NonNull WindowManager windowManager) {
    this.windowManager = windowManager;
  }

  public void init() {
    FlutterJNI.setAsyncWaitForVsyncDelegate(asyncWaitForVsyncDelegate);

    // TODO(mattcarroll): look into moving FPS reporting to a plugin
    float fps = windowManager.getDefaultDisplay().getRefreshRate();
    FlutterJNI.setRefreshRateFPS(fps);
  }
}
```

## 3. [ResourceExtractor](https://github.com/flutter/engine/blob/master/shell/platform/android/io/flutter/embedding/engine/loader/ResourceExtractor.java)：解压资源

### 解压到的目标目录
```java
package io.flutter.util;

import android.content.Context;
import android.os.Build;

public final class PathUtils {
  public static String getFilesDir(Context applicationContext) { // /data/data/com.example.hello_world/files
    return applicationContext.getFilesDir().getPath();
  }

  public static String getDataDirectory(Context applicationContext) { // /data/data/com.example.hello_world/app_flutter
    return applicationContext.getDir("flutter", Context.MODE_PRIVATE).getPath();
  }

  public static String getCacheDirectory(Context applicationContext) { // /data/data/com.example.hello_world/code_cache
    if (Build.VERSION.SDK_INT >= 21) {
      return applicationContext.getCodeCacheDir().getPath();
    } else {
      return applicationContext.getCacheDir().getPath();
    }
  }
}
```
我们看在`app_flutter`目录下解压了几个文件：
```bash
com.example.hello_world
├── app_flutter
│   ├── flutter_assets
│   │   ├── isolate_snapshot_data
│   │   ├── kernel_blob.bin
│   │   └── vm_snapshot_data
│   └── res_timestamp-1-1592911349542
```
而几个文件是在apk的`assets`目录下的：

```bash
 unzip -v app-debug.apk | grep assets
     109  Defl:N       53  51% 00-00-1980 00:00 e83e6b87  assets/flutter_assets/AssetManifest.json
     208  Defl:N      109  48% 00-00-1980 00:00 3d209bc2  assets/flutter_assets/FontManifest.json
  733096  Defl:N    83750  89% 00-00-1980 00:00 2196d49e  assets/flutter_assets/LICENSE
  134640  Defl:N    69819  48% 00-00-1980 00:00 c7c94b78  assets/flutter_assets/fonts/MaterialIcons-Regular.ttf
 3854401  Defl:N  1868737  52% 00-00-1980 00:00 d43b3d43  assets/flutter_assets/isolate_snapshot_data
27107248  Defl:N  9656566  64% 00-00-1980 00:00 9fb5ec9c  assets/flutter_assets/kernel_blob.bin
   93644  Defl:N    56533  40% 00-00-1980 00:00 ed090cf3  assets/flutter_assets/packages/cupertino_icons/assets/CupertinoIcons.ttf
   15672  Defl:N    11001  30% 00-00-1980 00:00 e1bd6880  assets/flutter_assets/vm_snapshot_data
```


